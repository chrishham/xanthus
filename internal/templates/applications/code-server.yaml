# Code Server Helm Values Template
# This template supports placeholder substitution for dynamic deployment

# Image configuration
image:
  repository: codercom/code-server
  tag: "{{VERSION}}"
  pullPolicy: Always

# Service configuration
service:
  type: ClusterIP
  port: 8080

# Ingress configuration with Traefik
ingress:
  enabled: true
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
  hosts:
    - host: "{{SUBDOMAIN}}.{{DOMAIN}}"
      paths:
        - /
  tls:
    - secretName: "{{DOMAIN}}-tls"
      hosts:
        - "{{SUBDOMAIN}}.{{DOMAIN}}"

# Persistence configuration
persistence:
  enabled: true
  size: 10Gi
  accessMode: ReadWriteOnce

# Resource configuration
resources:
  limits:
    cpu: "2"
    memory: "4Gi"
  requests:
    cpu: "100m"
    memory: "128Mi"

# Security context
securityContext:
  enabled: true
  fsGroup: 1000
  runAsUser: 1000

# Volume permissions
volumePermissions:
  enabled: true
  securityContext:
    runAsUser: 0

# Extra volumes for VS Code settings
extraVolumes:
  - name: vscode-settings
    configMap:
      name: "{{RELEASE_NAME}}-vscode-settings"
      optional: true

# Extra volume mounts for VS Code settings
extraVolumeMounts:
  - name: vscode-settings
    mountPath: /tmp/vscode-settings
    readOnly: true

# Init container to setup full development environment with all required tools
extraInitContainers: |
  - name: setup-environment
    image: ubuntu:22.04
    imagePullPolicy: IfNotPresent
    command:
      - bash
      - -c
      - |
        set -e
        echo "üöÄ Starting full development environment setup..."
        
        # Update package lists
        echo "üì¶ Updating package lists..."
        apt-get update
        
        # Install essential packages
        echo "üîß Installing build-essential, ripgrep, and development tools..."
        apt-get install -y build-essential ripgrep curl wget git vim nano
        
        # Create user if it doesn't exist and setup home directory
        if ! id -u coder > /dev/null 2>&1; then
          useradd -m -u 1000 -s /bin/bash coder
        fi
        
        # Install Go as root first (more reliable)
        echo "üêπ Installing Go..."
        ARCH=$(uname -m)
        case "$ARCH" in
          x86_64) ARCH="amd64" ;;
          aarch64 | arm64) ARCH="arm64" ;;
          *) echo "‚ùå Unsupported architecture: $ARCH"; exit 1 ;;
        esac
        
        # Use a specific stable Go version to avoid API issues
        GO_VERSION="1.23.4"
        TARFILE="go${GO_VERSION}.linux-${ARCH}.tar.gz"
        DOWNLOAD_URL="https://go.dev/dl/${TARFILE}"
        
        echo "üîΩ Downloading Go ${GO_VERSION}..."
        cd /tmp
        curl -LO "$DOWNLOAD_URL"
        
        if [ ! -f "${TARFILE}" ]; then
          echo "‚ùå Failed to download Go tarball"
          exit 1
        fi
        
        echo "üì¶ Extracting Go to /usr/local..."
        rm -rf /usr/local/go
        tar -C /usr/local -xzf "${TARFILE}"
        rm "${TARFILE}"
        
        # Now switch to coder user for the rest
        su - coder << 'EOF'
        set -e
        cd /home/coder
        
        # Install Volta (Node.js version manager)
        echo "üåê Installing Volta..."
        curl https://get.volta.sh | bash
        
        # Setup Volta environment
        export VOLTA_HOME="$HOME/.volta"
        export PATH="$VOLTA_HOME/bin:$PATH"
        
        # Install Node.js via Volta
        echo "üì¶ Installing Node.js..."
        ~/.volta/bin/volta install node@20
        
        # Install global npm packages
        echo "üîß Installing Claude Code and ccusage..."
        ~/.volta/bin/npm install -g @anthropic-ai/claude-code
        ~/.volta/bin/npm install -g ccusage
        
        # Setup environment in bashrc
        cat >> ~/.bashrc << 'BASHRC_EOF'
        # Xanthus Code-Server Development Environment
        export VOLTA_HOME="$HOME/.volta"
        export PATH="$VOLTA_HOME/bin:$PATH"
        export PATH="$PATH:/usr/local/go/bin"
        export GOPATH="$HOME/go"
        export PATH="$PATH:$GOPATH/bin"
        
        # Useful aliases
        alias ll='ls -alF'
        alias la='ls -A'
        alias l='ls -CF'
        alias ..='cd ..'
        alias ...='cd ../..'
        
        # Development shortcuts
        alias gst='git status'
        alias gco='git checkout'
        alias gc='git commit'
        alias gp='git push'
        alias gl='git log --oneline'
        
        # Welcome message
        echo "üéâ Welcome to your Xanthus Code-Server development environment!"
        echo "üìù Installed tools: Go $(go version | cut -d' ' -f3), Node.js $(node --version), npm $(npm --version)"
        echo "üîß Build tools, ripgrep, git, and development packages are ready!"
        echo ""
        BASHRC_EOF
        
        # Create development directories
        mkdir -p ~/workspace ~/go/src ~/go/bin ~/go/pkg ~/.local/share/code-server/User
        
        # Verify installations
        echo "‚úÖ Verifying installations..."
        /usr/local/go/bin/go version
        ~/.volta/bin/node --version
        ~/.volta/bin/npm --version
        which gcc
        which make
        which rg
        
        EOF
        
        # Setup VS Code settings if available
        if [ -d /tmp/vscode-settings ]; then
          echo "üìù Copying VS Code settings..."
          mkdir -p /home/coder/.local/share/code-server/User
          cp -f /tmp/vscode-settings/settings.json /home/coder/.local/share/code-server/User/settings.json 2>/dev/null || echo "No settings.json found, skipping..."
          cp -f /tmp/vscode-settings/keybindings.json /home/coder/.local/share/code-server/User/keybindings.json 2>/dev/null || echo "No keybindings.json found, skipping..."
        fi
        
        # Fix all permissions
        echo "üîí Fixing permissions..."
        chown -R 1000:1000 /home/coder
        
        echo "üéâ Full development environment setup complete!"
    securityContext:
      runAsUser: 0
    volumeMounts:
      - name: data
        mountPath: /home/coder
      - name: vscode-settings
        mountPath: /tmp/vscode-settings
        readOnly: true

# Pod annotations
podAnnotations: {}

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity: {}

# Service account
serviceAccount:
  create: true
  annotations: {}
  name: ""

# Replica count
replicaCount: 1

# Extra environment variables
extraVars: []

# Extra arguments
extraArgs: []

# Extra ports
extraPorts: []

# Priority class name
priorityClassName: ""

# Image pull secrets
imagePullSecrets: []

# Full name override
fullnameOverride: ""

# Name override
nameOverride: ""

# Hostname override
hostnameOverride: ""

# Lifecycle hooks
lifecycle:
  enabled: false