var e=Object.defineProperty,t=(t,r,o)=>((t,r,o)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o)(t,"symbol"!=typeof r?r+"":r,o);import{w as r,b as o,d as s}from"./DosQeM9E.js";const n={},i=function(e,t,r){let o=Promise.resolve();if(t&&t.length>0){const e=document.getElementsByTagName("link"),s=document.querySelector("meta[property=csp-nonce]"),i=s?.nonce||s?.getAttribute("nonce");o=Promise.allSettled(t.map(t=>{if(t=function(e,t){return new URL(e,t).href}(t,r),t in n)return;n[t]=!0;const o=t.endsWith(".css"),s=o?'[rel="stylesheet"]':"";if(!!r)for(let r=e.length-1;r>=0;r--){const s=e[r];if(s.href===t&&(!o||"stylesheet"===s.rel))return}else if(document.querySelector(`link[href="${t}"]${s}`))return;const a=document.createElement("link");return a.rel=o?"stylesheet":"modulepreload",o||(a.as="script"),a.crossOrigin="",a.href=t,i&&a.setAttribute("nonce",i),document.head.appendChild(a),o?new Promise((e,r)=>{a.addEventListener("load",e),a.addEventListener("error",()=>r(new Error(`Unable to preload CSS for ${t}`)))}):void 0}))}function s(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return o.then(t=>{for(const e of t||[])"rejected"===e.status&&s(e.reason);return e().catch(s)})},a=r({loading:!1,loadingTitle:"Processing...",loadingMessage:"Please wait while the operation completes.",currentPage:"",modals:{}}),c=(e,t)=>{a.update(r=>({...r,loading:!0,loadingTitle:e,loadingMessage:t}))},l=()=>{a.update(e=>({...e,loading:!1}))},d=e=>{a.update(t=>({...t,currentPage:e}))},u=e=>{a.update(t=>({...t,loadingTitle:e}))},h=e=>{a.update(t=>({...t,loadingMessage:e}))};const p=new class{constructor(){t(this,"notifications",[]),t(this,"notificationListeners",[]),t(this,"maxNotifications",5)}async handleAPIError(e,t,r){console.error(`API Error in ${t}:`,e);const o={message:this.extractErrorMessage(e),code:e.status||e.code,timestamp:Date.now(),context:t,retryable:this.isRetryableError(e)};await this.showErrorNotification(o,r),this.logError(o,e)}async handleNetworkError(e,t){const r={message:"Network connection failed. Please check your internet connection.",timestamp:Date.now(),context:e,retryable:!0};await this.showErrorNotification(r,t)}async handleValidationError(e,t){const r=Array.isArray(e)?e:[e],o=1===r.length?r[0]:`${r.length} validation errors occurred`,s={id:this.generateId(),type:"warning",title:"Validation Error",message:o,timestamp:Date.now(),dismissible:!0,autoClose:8};this.addNotification(s)}showSuccess(e,t,r=5){const o={id:this.generateId(),type:"success",title:e,message:t,timestamp:Date.now(),dismissible:!0,autoClose:r};this.addNotification(o)}showInfo(e,t,r=8){const o={id:this.generateId(),type:"info",title:e,message:t,timestamp:Date.now(),dismissible:!0,autoClose:r};this.addNotification(o)}showWarning(e,t,r=10){const o={id:this.generateId(),type:"warning",title:e,message:t,timestamp:Date.now(),dismissible:!0,autoClose:r};this.addNotification(o)}subscribe(e){return this.notificationListeners.push(e),e([...this.notifications]),()=>{const t=this.notificationListeners.indexOf(e);t>-1&&this.notificationListeners.splice(t,1)}}dismiss(e){this.notifications=this.notifications.filter(t=>t.id!==e),this.notifyListeners()}clearAll(){this.notifications=[],this.notifyListeners()}async showErrorNotification(e,t){const r=[];t&&e.retryable&&r.push({label:"Retry",action:t,primary:!0});const s={id:this.generateId(),type:"error",title:this.getErrorTitle(e),message:e.message,timestamp:e.timestamp,dismissible:!0,actions:r.length>0?r:void 0};if(this.addNotification(s),this.isCriticalError(e)&&o)try{const{default:t}=await i(async()=>{const{default:e}=await import("./CT2pLRIc.js");return{default:e}},[],import.meta.url);await t.fire({title:"Critical Error",text:e.message,icon:"error",confirmButtonColor:"#ef4444"})}catch(n){console.error("Failed to show critical error dialog:",n)}}extractErrorMessage(e){return"string"==typeof e?e:e?.message?e.message:e?.error?e.error:e?.details?e.details:e?.statusText?e.statusText:e?.response?.data?.error?e.response.data.error:e?.response?.data?.message?e.response.data.message:"An unexpected error occurred"}isRetryableError(e){const t=e?.status||e?.response?.status;return!t||(t>=500||(429===t||408===t))}isCriticalError(e){return 401===e.code||403===e.code||("number"==typeof e.code&&e.code>=500||(!(!e.context?.includes("deployment")||!e.message.includes("failed"))||!(!e.context?.includes("vps")||!e.message.includes("unreachable"))))}getErrorTitle(e){if(401===e.code)return"Authentication Required";if(403===e.code)return"Access Denied";if(404===e.code)return"Resource Not Found";if(429===e.code)return"Rate Limited";if("number"==typeof e.code&&e.code>=500)return"Server Error";if(e.context){const t={vps:"VPS Error",applications:"Application Error",dns:"DNS Error",version:"Version Management Error",auth:"Authentication Error"};for(const[r,o]of Object.entries(t))if(e.context.toLowerCase().includes(r))return o}return"Error"}addNotification(e){this.notifications.unshift(e),this.notifications.length>this.maxNotifications&&(this.notifications=this.notifications.slice(0,this.maxNotifications)),e.autoClose&&setTimeout(()=>{this.dismiss(e.id)},1e3*e.autoClose),this.notifyListeners()}notifyListeners(){this.notificationListeners.forEach(e=>{e([...this.notifications])})}logError(e,t){const r={timestamp:new Date(e.timestamp).toISOString(),context:e.context,message:e.message,code:e.code,userAgent:navigator.userAgent,url:window.location.href,originalError:t?JSON.stringify(t,null,2):void 0};console.group(`ðŸš¨ Error in ${e.context}`),console.error("Error Details:",r),t&&console.error("Original Error:",t),console.groupEnd()}generateId(){return Math.random().toString(36).substr(2,9)}},f={user:null,tokens:null,loading:!1,error:null,isAuthenticated:!1};const g=function(){const{subscribe:e,set:t,update:o}=r(f);return{subscribe:e,set:t,update:o,login:async e=>{o(e=>({...e,loading:!0,error:null}));try{const t=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cf_token:e})});if(t.ok){const e=await t.json();return y(e),await k(),!0}{const e=await t.json();return o(t=>({...t,error:e.error||"Login failed"})),!1}}catch(t){return o(e=>({...e,error:"Network error during login"})),!1}finally{o(e=>({...e,loading:!1}))}},logout:async()=>{o(e=>({...e,loading:!0}));try{const e=w();e&&await fetch("/api/auth/logout",{method:"POST",headers:{Authorization:`${e.token_type} ${e.access_token}`,"Content-Type":"application/json"}})}catch(e){console.error("Logout error:",e)}finally{t(f),E(),window.location.href="/app/login"}},initialize:async()=>{w()&&await k()}}}();s(g,e=>e.user),s(g,e=>e.isAuthenticated),s(g,e=>e.loading),s(g,e=>e.error);const m="xanthus_tokens",y=e=>{localStorage.setItem(m,JSON.stringify({...e,expires_at:Date.now()+1e3*e.expires_in}))},w=()=>{try{const e=localStorage.getItem(m);if(!e)return null;const t=JSON.parse(e);return{access_token:t.access_token,refresh_token:t.refresh_token,token_type:t.token_type,expires_in:t.expires_in}}catch{return null}},E=()=>{localStorage.removeItem(m)},b=()=>{try{const e=localStorage.getItem(m);if(!e)return!1;const t=JSON.parse(e);return Date.now()>=t.expires_at-3e5}catch{return!1}},k=async()=>{g.update(e=>({...e,loading:!0}));try{if(b()){if(!(await T()))return void g.update(e=>({...e,user:null,isAuthenticated:!1,loading:!1}))}const e=w();if(!e||(()=>{try{const e=localStorage.getItem(m);if(!e)return!0;const t=JSON.parse(e);return Date.now()>=t.expires_at}catch{return!0}})())return void g.update(e=>({...e,user:null,isAuthenticated:!1,loading:!1}));const t=await fetch("/api/user/profile",{headers:{Authorization:`${e.token_type} ${e.access_token}`}});if(t.ok){const e=await t.json();e.authenticated&&e.user?g.update(t=>({...t,user:{id:e.user.id,account_id:e.user.account_id,namespace_id:e.user.namespace_id,isAuthenticated:!0},isAuthenticated:!0,loading:!1})):g.update(e=>({...e,user:null,isAuthenticated:!1,loading:!1}))}else g.update(e=>({...e,user:null,isAuthenticated:!1,loading:!1}))}catch(e){console.error("Auth check error:",e),g.update(e=>({...e,user:null,isAuthenticated:!1,loading:!1}))}},T=async()=>{const e=w();if(!e?.refresh_token)return!1;try{const t=await fetch("/api/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e.refresh_token})});if(t.ok){const e=await t.json();return y(e),!0}return E(),g.set(f),window.location.href="/app/login",!1}catch(t){return console.error("Token refresh error:",t),!1}},N=async(e,t={})=>{b()&&await T();const r=w();if(!r)throw new Error("No authentication tokens available");return fetch(e,{...t,headers:{...t.headers,Authorization:`${r.token_type} ${r.access_token}`}})};class _ extends Error{constructor(e,t,r){super(e),this.status=t,this.response=r,this.name="ApiError"}}const A=new class{constructor(){t(this,"baseUrl","/api")}async get(e,t="API",r=!0){try{const t=await N(`${this.baseUrl}${e}`,{method:"GET",headers:{"Content-Type":"application/json"}});return await this.handleResponse(t)}catch(o){throw r&&await this.handleError(o,t),o}}async post(e,t,r="API",o=!0){try{const r=await N(`${this.baseUrl}${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:t?JSON.stringify(t):void 0});return await this.handleResponse(r)}catch(s){throw o&&await this.handleError(s,r),s}}async put(e,t){const r=await N(`${this.baseUrl}${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:t?JSON.stringify(t):void 0});return this.handleResponse(r)}async delete(e){const t=await N(`${this.baseUrl}${e}`,{method:"DELETE",headers:{"Content-Type":"application/json"}});return this.handleResponse(t)}async handleResponse(e){if(!e.ok){let t=`HTTP ${e.status}: ${e.statusText}`;try{const r=await e.json();t=r.error||r.message||t}catch{}throw new _(t,e.status,e)}const t=e.headers.get("Content-Type");if(!t||!t.includes("application/json"))return{};try{return await e.json()}catch{return{}}}async handleError(e,t){this.isNetworkError(e)?await p.handleNetworkError(t):await p.handleAPIError(e,t)}isNetworkError(e){return!e.status&&(e.message?.includes("NetworkError")||e.message?.includes("Failed to fetch")||e.message?.includes("fetch")||"TypeError"===e.name)}async legacyGet(e){const t=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json"}});return this.handleResponse(t)}async legacyPost(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:t?JSON.stringify(t):void 0});return this.handleResponse(r)}async legacyDelete(e){const t=await fetch(e,{method:"DELETE",headers:{"Content-Type":"application/json"}});return this.handleResponse(t)}};export{i as _,A as a,g as b,l as c,d,p as e,u as f,h as g,c as s,a as u};
